<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kisan Sahayak — Demo</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- Lucide (non-module global build) -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .tab-button.active { box-shadow: inset 0 3px 0 0 #16a34a; background-color: white; color: #16a34a; }
    /* ensure chat area grows correctly */
    #main-content { min-height: calc(100vh - 160px); }
  </style>
</head>
<body class="bg-green-50 min-h-screen flex flex-col items-center p-4">

  <!-- Header -->
  <header class="w-full max-w-4xl bg-white shadow-xl rounded-xl overflow-hidden">
    <div class="p-4 bg-green-700 text-white">
      <h1 class="text-2xl font-extrabold">Kisan Sahayak (किसान सहायक)</h1>
      <p class="text-sm opacity-90 mt-1">AI-powered agricultural assistant — demo frontend</p>
    </div>

    <!-- Tabs -->
    <nav id="tab-nav" class="flex bg-gray-50 border-t border-gray-200">
      <button data-tab="Chat" class="tab-button active flex-1 p-3 text-sm font-semibold flex flex-col items-center justify-center text-green-800 bg-white border-t-4 border-green-600">
        <i data-lucide="message-circle" class="w-5 h-5 mb-1"></i>
        <span class="hidden sm:inline">Chat</span>
      </button>
      <button data-tab="News" class="tab-button flex-1 p-3 text-sm font-semibold flex flex-col items-center justify-center text-gray-500 hover:text-green-600">
        <i data-lucide="book-open" class="w-5 h-5 mb-1"></i>
        <span class="hidden sm:inline">News</span>
      </button>
      <button data-tab="Market" class="tab-button flex-1 p-3 text-sm font-semibold flex flex-col items-center justify-center text-gray-500 hover:text-green-600">
        <i data-lucide="truck" class="w-5 h-5 mb-1"></i>
        <span class="hidden sm:inline">Market</span>
      </button>
    </nav>
  </header>

  <!-- Main -->
  <main id="main-content" class="w-full max-w-4xl bg-white shadow-xl mt-6 rounded-xl overflow-hidden flex-1 flex flex-col">
    <!-- Chat -->
    <section id="Chat" class="tab-content flex flex-col h-full">
      <div class="flex items-center justify-between p-4 border-b border-gray-200 bg-white/70">
        <h2 class="text-xl font-bold text-green-700">Advisory Chatbot (सलाहकार)</h2>
        <div class="flex items-center space-x-3">
          <i data-lucide="globe" class="w-5 h-5 text-green-600"></i>
          <select id="language-select" class="p-2 border rounded-lg text-sm bg-white"></select>
        </div>
      </div>

      <div id="chat-history" class="flex-1 overflow-y-auto p-4 space-y-4" style="min-height:300px;">
        <!-- chat messages -->
      </div>

      <form id="chat-form" class="p-4 border-t border-gray-200 bg-white flex items-center space-x-3">
        <input id="chat-input" type="text" placeholder="Type your question..." class="flex-1 p-3 border rounded-xl focus:ring-2 focus:ring-green-500" />
        <button id="send-button" type="submit" class="p-3 bg-green-600 text-white rounded-xl shadow-md hover:bg-green-700 disabled:opacity-50" disabled>
          <i data-lucide="send" class="w-5 h-5"></i>
        </button>
      </form>
    </section>

    <!-- News -->
    <section id="News" class="tab-content hidden p-6 h-full overflow-y-auto">
      <h2 class="text-2xl font-extrabold text-green-800 mb-4 flex items-center">
        <i data-lucide="book-open" class="w-6 h-6 mr-2"></i> Latest Kisan News
      </h2>
      <div id="news-list" class="space-y-4"></div>
    </section>

    <!-- Market -->
    <section id="Market" class="tab-content hidden p-6 h-full overflow-y-auto">
      <h2 class="text-2xl font-extrabold text-green-800 mb-4 flex items-center">
        <i data-lucide="truck" class="w-6 h-6 mr-2"></i> Mandi Prices
      </h2>
      <div id="mandi-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      <div id="weather-advisory" class="mt-6 p-4 bg-green-50 rounded-xl border border-green-200"></div>
    </section>
  </main>

  <!-- Footer / notes -->
  <div class="w-full max-w-4xl text-xs text-gray-600 mt-4">
    <p><strong>Note:</strong> This is a demo frontend. For production use, never expose API keys in client-side code — use a backend proxy.</p>
  </div>

  <!-- App script -->
  <script>
  /**************************************************************************
   * Demo frontend script
   * - uses lucide (global) => call lucide.createIcons() after dynamic updates
   * - mock fallback if API_KEY is empty
   **************************************************************************/

  // ========== CONFIG ==========
  const API_KEY = ""; // <--- PUT BACKEND-PROXIED KEY HERE (not recommended client-side)
  const TEXT_MODEL = 'gemini-2.5-flash-preview-05-20';
  const TTS_MODEL = 'gemini-2.5-flash-preview-tts';

  let currentState = {
    chatHistory: [],
    isLoading: false,
    isSpeaking: false,
    currentLanguage: { code: 'en', name: 'English', voice: 'Achird' }
  };

  const LANGUAGES = [
    { code: 'en', name: 'English', voice: 'Achird' },
    { code: 'hi', name: 'हिन्दी', voice: 'Gacrux' },
    { code: 'mr', name: 'मराठी', voice: 'Umbriel' },
    { code: 'ta', name: 'தமிழ்', voice: 'Despina' },
  ];

  const INITIAL_NEWS = [
    { title: "PM launches 'PM Dhan Dhaanya Krishi Yojana'", snippet: "Two major schemes to boost productivity and reduce dependency on imports.", date: "Oct 11, 2025" },
    { title: "Kharif Sowing Acreage Crosses Normal Area", snippet: "Total Kharif crops exceeded the normal area; reservoir storage healthy.", date: "Oct 13, 2025" },
    { title: "ICAR Shortlists New Wheat Varieties", snippet: "New wheat varieties approved ahead of Rabi season.", date: "Oct 13, 2025" }
  ];

  const INITIAL_MANDI = [
    { crop: "Wheat (Gehu)", market: "Ashoknagar (MP)", modalPrice: "₹ 2735 / Quintal", trend: "Stable" },
    { crop: "Rice (Chawal)", market: "Average India", modalPrice: "₹ 3200 / Quintal", trend: "Rising" },
    { crop: "Mustard", market: "Udaipur (RJ)", modalPrice: "₹ 7000 / Quintal", trend: "High" }
  ];

  // ========== UTILS ==========
  const fetchWithRetry = async (url, options, maxRetries = 3) => {
    for (let attempt = 0; attempt < maxRetries; attempt++) {
      try {
        const res = await fetch(url, options);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        return res;
      } catch (err) {
        console.error('attempt', attempt+1, 'failed:', err.message);
        if (attempt === maxRetries -1) throw err;
        await new Promise(r => setTimeout(r, Math.pow(2, attempt) * 500));
      }
    }
  };

  // Base64 -> ArrayBuffer
  const base64ToArrayBuffer = (base64) => {
    const binary = atob(base64);
    const len = binary.length;
    const bytes = new Uint8Array(len);
    for (let i=0;i<len;i++) bytes[i] = binary.charCodeAt(i);
    return bytes.buffer;
  };

  // PCM16 -> WAV (works for demo)
  const pcmToWav = (pcmData, sampleRate = 24000) => {
    const numChannels = 1;
    const bitsPerSample = 16;
    const blockAlign = numChannels * (bitsPerSample/8);
    const byteRate = sampleRate * blockAlign;
    const dataLength = pcmData.byteLength;
    const fileLength = 44 + dataLength;
    const buffer = new ArrayBuffer(fileLength);
    const view = new DataView(buffer);
    const pcmView = new Int16Array(pcmData);
    let offset = 0;

    view.setUint32(offset, 0x52494646, false); offset += 4; // "RIFF"
    view.setUint32(offset, fileLength - 8, true); offset += 4;
    view.setUint32(offset, 0x57415645, false); offset += 4; // "WAVE"
    view.setUint32(offset, 0x666d7420, false); offset += 4; // "fmt "
    view.setUint32(offset, 16, true); offset += 4;
    view.setUint16(offset, 1, true); offset += 2; // PCM
    view.setUint16(offset, numChannels, true); offset += 2;
    view.setUint32(offset, sampleRate, true); offset += 4;
    view.setUint32(offset, byteRate, true); offset += 4;
    view.setUint16(offset, blockAlign, true); offset += 2;
    view.setUint16(offset, bitsPerSample, true); offset += 2;
    view.setUint32(offset, 0x64617461, false); offset += 4; // "data"
    view.setUint32(offset, dataLength, true); offset += 4;

    for (let i=0;i<pcmView.length;i++) {
      view.setInt16(offset, pcmView[i], true);
      offset += 2;
    }
    return new Blob([view], { type: 'audio/wav' });
  };

  // ========== GEMINI API (demo-friendly) ==========
  // NOTE: For security, don't place production API keys in client JS.
  const fetchGeminiResponse = async (query, languageName) => {
    // If API_KEY is empty, return a mock helpful response — useful for local testing.
    if (!API_KEY) {
      console.warn('API_KEY empty — returning mock response.');
      return {
        text: `Demo reply (${languageName}): I got your query — "${query}". For production, configure a backend to call the Gemini API securely.`,
        sources: []
      };
    }

    // Example call shape — adjust to your backend/proxy schema.
    try {
      const apiUrl = `https://your-backend.example.com/gemini-text`; // <-- replace with real proxy endpoint
      const res = await fetchWithRetry(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ model: TEXT_MODEL, query, language: languageName })
      });
      const json = await res.json();
      return { text: json.text || 'No text', sources: json.sources || [] };
    } catch (e) {
      console.error('Gemini fetch error:', e);
      return { text: "Error contacting advisory service. Please try later.", sources: [] };
    }
  };

  // TTS fetch (demo)
  const fetchTTSAudio = async (text, voice) => {
    if (!API_KEY) {
      // mock TTS using SpeechSynthesis (client) for demo if no server TTS
      return new Promise((resolve, reject) => {
        try {
          const utter = new SpeechSynthesisUtterance(text);
          // do not block — return a flag to use speechSynthesis instead
          resolve({ useSpeechSynthesis: true, utterance: utter });
        } catch (e) { reject(e); }
      });
    }

    // If using a backend, implement fetch to your TTS proxy that returns base64 PCM
    try {
      const apiUrl = `https://your-backend.example.com/gemini-tts`;
      const res = await fetchWithRetry(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ model: TTS_MODEL, text, voice })
      });
      const json = await res.json();
      if (json && json.base64) {
        const pcm = base64ToArrayBuffer(json.base64);
        const wavBlob = pcmToWav(pcm);
        return { url: URL.createObjectURL(wavBlob) };
      }
      return null;
    } catch (e) {
      console.error('TTS error:', e);
      return null;
    }
  };

  // ========== RENDERING ==========
  const renderChatHistory = () => {
    const $history = $('#chat-history');
    $history.empty();

    if (currentState.chatHistory.length === 0) {
      $history.append(`
        <div class="text-center text-gray-500 pt-10">
          <i data-lucide="zap" class="w-8 h-8 mx-auto text-green-400 mb-2"></i>
          <p>Ask me anything about crops, pests, fertilizers, or market prices in your local language!</p>
          <p class="text-xs mt-1">Example: "मेरे खेत में गेहूँ पीला पड़ रहा है, क्या करूँ?"</p>
        </div>
      `);
      // ensure icons render
      lucide.createIcons();
      $history.scrollTop($history.prop('scrollHeight'));
      return;
    }

    currentState.chatHistory.forEach((msg) => {
      const isUser = msg.isUser;
      const alignment = isUser ? 'justify-end' : 'justify-start';
      const bubbleClasses = isUser ? 'bg-green-600 text-white rounded-br-none' : 'bg-gray-100 text-gray-800 rounded-tl-none';
      const messageId = msg.id || Date.now();
      const sourcesHtml = (msg.sources && msg.sources.length) ? `
        <div class="mt-2 pt-2 border-t border-gray-200 text-xs text-gray-600">
          <p class="font-semibold">Sources:</p>
          ${msg.sources.map((s, i) => `<a href="${s.uri || '#'}" target="_blank" rel="noopener" class="block truncate"> ${i+1}. ${s.title || s.uri || 'source'}</a>`).join('')}
        </div>` : '';

      const listenButtonHtml = (!isUser) ? `
        <button data-msg-id="${messageId}" data-msg-text="${escapeHtml(msg.text)}" class="tts-button mt-2 text-xs font-semibold flex items-center text-green-800 hover:text-green-900 bg-white/70 px-2 py-1 rounded-full disabled:opacity-50">
          <i data-lucide="mic" class="w-3 h-3 mr-1"></i>
          <span>Listen (TTS)</span>
        </button>
      ` : '';

      const html = `
        <div class="flex w-full ${alignment} mb-4">
          <div class="max-w-xs md:max-w-md lg:max-w-lg p-3 rounded-2xl shadow-lg ${bubbleClasses}">
            <p class="text-sm whitespace-pre-wrap">${escapeHtml(msg.text)}</p>
            ${listenButtonHtml}
            ${sourcesHtml}
          </div>
        </div>
      `;
      $history.append(html);
    });

    // loading indicator
    if (currentState.isLoading) {
      $history.append(`
        <div class="flex justify-start">
          <div class="bg-gray-100 p-3 rounded-2xl rounded-tl-none shadow-lg">
            <div class="flex space-x-1">
              <span class="animate-bounce h-2 w-2 bg-green-500 rounded-full"></span>
              <span class="animate-bounce h-2 w-2 bg-green-500 rounded-full" style="animation-delay:0.2s"></span>
              <span class="animate-bounce h-2 w-2 bg-green-500 rounded-full" style="animation-delay:0.4s"></span>
            </div>
          </div>
        </div>
      `);
    }

    // re-render lucide icons for newly added elements
    lucide.createIcons();
    $history.scrollTop($history.prop('scrollHeight'));
  };

  const renderNews = () => {
    const $newsList = $('#news-list').empty();
    INITIAL_NEWS.forEach(n => {
      const html = `
        <div class="p-4 bg-white/50 rounded-xl shadow border border-gray-100 hover:shadow-lg transition">
          <div class="flex justify-between items-center text-xs text-gray-500 mb-2">
            <span class="flex items-center"><i data-lucide="book-open" class="w-3 h-3 mr-1"></i> AGRICULTURE</span>
            <span>${n.date}</span>
          </div>
          <h3 class="text-lg font-bold text-green-800 mb-1">${n.title}</h3>
          <p class="text-sm text-gray-700">${n.snippet}</p>
        </div>
      `;
      $newsList.append(html);
    });
    lucide.createIcons();
  };

  const renderMandi = () => {
    const $mandi = $('#mandi-list').empty();
    INITIAL_MANDI.forEach(item => {
      const [price, unit] = item.modalPrice.split('/');
      const trendColor = item.trend === 'Rising' ? 'text-red-500' : 'text-green-500';
      const html = `
        <div class="p-4 bg-white/60 rounded-xl shadow-md border border-green-100 flex justify-between items-center">
          <div>
            <p class="text-sm font-medium text-gray-500">${item.market}</p>
            <h3 class="text-xl font-extrabold text-green-700">${item.crop}</h3>
          </div>
          <div class="text-right">
            <p class="text-2xl font-black text-green-900">${price.trim()}</p>
            <p class="text-sm text-gray-600">${unit ? unit.trim() : ''} <span class="font-semibold ${trendColor}">(${item.trend})</span></p>
          </div>
        </div>
      `;
      $mandi.append(html);
    });

    $('#weather-advisory').html(`
      <p class="font-semibold text-green-800">Weather Advisory (उदाहरण)</p>
      <p class="text-sm text-green-700 mt-1 flex items-center">
        <i data-lucide="sun" class="w-4 h-4 mr-1 text-yellow-500"></i>
        Current Outlook: Mild temperatures, clear skies. Ideal for Rabi sowing in many Northern regions.
      </p>
    `);

    lucide.createIcons();
  };

  const updateLanguageSelector = () => {
    const $sel = $('#language-select').empty();
    LANGUAGES.forEach(lang => {
      $sel.append(`<option value="${lang.code}" data-voice="${lang.voice}">${lang.name}</option>`);
    });
    $sel.val(currentState.currentLanguage.code);
    $('#chat-input').attr('placeholder', `Type your question in ${currentState.currentLanguage.name}...`);
  };

  // ========== EVENTS & HANDLERS ==========
  const escapeHtml = (unsafe) => {
    return (unsafe || '').toString().replace(/[&<>"'`]/g, (m) => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;', '`':'&#96;' }[m]));
  };

  const setAppState = (patch) => {
    Object.assign(currentState, patch);
    renderChatHistory();
    $('#send-button').prop('disabled', currentState.isLoading || !$('#chat-input').val().trim());
    $('#chat-input').prop('disabled', currentState.isLoading);
    $('#language-select').prop('disabled', currentState.isLoading);
  };

  const handleLanguageChange = (e) => {
    const code = $(e.target).val();
    const lang = LANGUAGES.find(l => l.code === code);
    if (lang) {
      setAppState({ currentLanguage: lang });
      $('#chat-input').attr('placeholder', `Type your question in ${lang.name}...`);
    }
  };

  const handleChatSubmit = async (ev) => {
    ev.preventDefault();
    const userMessage = $('#chat-input').val().trim();
    if (!userMessage || currentState.isLoading) return;

    $('#chat-input').val('');
    setAppState({
      isLoading: true,
      chatHistory: [...currentState.chatHistory, { text: userMessage, isUser: true, sources: [], id: Date.now() }]
    });

    const query = `User query: "${userMessage}"`;
    const result = await fetchGeminiResponse(query, currentState.currentLanguage.name);

    // update with AI response
    setAppState({
      isLoading: false,
      chatHistory: [...currentState.chatHistory, { text: result.text, isUser: false, sources: result.sources || [], id: Date.now()+1 }]
    });
  };

  const handleSpeech = async (text, buttonEl) => {
    if (currentState.isSpeaking) return;
    setAppState({ isSpeaking: true });

    const $btn = $(buttonEl);
    $btn.prop('disabled', true);
    $btn.find('i').attr('data-lucide', 'refresh-cw').addClass('animate-spin');
    $btn.find('span').text('Speaking...');

    const voice = currentState.currentLanguage.voice;
    const tts = await fetchTTSAudio(text, voice);

    if (!tts) {
      alert('TTS generation failed.');
      setAppState({ isSpeaking: false });
      $btn.prop('disabled', false);
      $btn.find('i').attr('data-lucide', 'mic').removeClass('animate-spin');
      $btn.find('span').text('Listen (TTS)');
      lucide.createIcons();
      return;
    }

    // If backend not configured, use SpeechSynthesis (demo)
    if (tts.useSpeechSynthesis) {
      const utter = tts.utterance;
      utter.lang = currentState.currentLanguage.code || 'en';
      utter.onend = () => {
        setAppState({ isSpeaking: false });
        $btn.find('i').attr('data-lucide', 'mic').removeClass('animate-spin');
        $btn.find('span').text('Listen (TTS)');
        $btn.prop('disabled', false);
        lucide.createIcons();
      };
      speechSynthesis.speak(utter);
    } else if (tts.url) {
      const audio = new Audio(tts.url);
      audio.onended = () => {
        setAppState({ isSpeaking: false });
        $btn.find('i').attr('data-lucide', 'mic').removeClass('animate-spin');
        $btn.find('span').text('Listen (TTS)');
        $btn.prop('disabled', false);
        URL.revokeObjectURL(tts.url);
        lucide.createIcons();
      };
      audio.onerror = () => {
        alert('Audio playback error.');
        setAppState({ isSpeaking: false });
        $btn.find('i').attr('data-lucide', 'mic').removeClass('animate-spin');
        $btn.find('span').text('Listen (TTS)');
        $btn.prop('disabled', false);
        lucide.createIcons();
      };
      audio.play().catch(err => {
        console.error('playback failed', err);
        setAppState({ isSpeaking: false });
        $btn.find('i').attr('data-lucide', 'mic').removeClass('animate-spin');
        $btn.find('span').text('Listen (TTS)');
        $btn.prop('disabled', false);
        lucide.createIcons();
      });
    }
    lucide.createIcons();
  };

  // tab handler
  const handleTabClick = (ev) => {
    const newTab = $(ev.currentTarget).data('tab');
    $('.tab-content').addClass('hidden');
    $('#' + newTab).removeClass('hidden');

    $('.tab-button').removeClass('active text-green-800 bg-white border-t-4 border-green-600').addClass('text-gray-500 hover:text-green-600');
    $(ev.currentTarget).addClass('active text-green-800 bg-white border-t-4 border-green-600').removeClass('text-gray-500 hover:text-green-600');

    if (newTab === 'Chat') $('#chat-history').scrollTop($('#chat-history').prop('scrollHeight'));
    lucide.createIcons();
  };

  // ========== INIT ==========
  const setupEventListeners = () => {
    $('#tab-nav').on('click', '.tab-button', handleTabClick);
    $('#language-select').on('change', handleLanguageChange);
    $('#chat-form').on('submit', handleChatSubmit);
    $('#chat-history').on('click', '.tts-button', function() {
      const text = $(this).data('msg-text');
      handleSpeech(text, this);
    });
    $('#chat-input').on('input', function() {
      const val = $(this).val().trim();
      $('#send-button').prop('disabled', val.length === 0 || currentState.isLoading);
    });
  };

  const initializeApp = () => {
    updateLanguageSelector();
    renderNews();
    renderMandi();
    renderChatHistory();
    setupEventListeners();
    lucide.createIcons(); // initial icon render
  };

  $(document).ready(initializeApp);
  </script>
</body>
</html>
